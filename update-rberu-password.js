// rberuãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
// å®Ÿè¡Œæ–¹æ³•: node update-rberu-password.js

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceRoleKey) {
  console.error('âŒ ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  process.exit(1);
}

// Service Role Keyã‚’ä½¿ç”¨ã—ã¦Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
const supabase = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function updateRberuPassword() {
  try {
    console.log('ğŸ” rberuãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã™...\n');

    // 1. rberuã«é–¢é€£ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    console.log('1ï¸âƒ£ rberuãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ä¸­...');
    const { data: { users }, error: listError } = await supabase.auth.admin.listUsers();

    if (listError) {
      console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', listError);
      return;
    }

    // rberuã«é–¢é€£ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¢ã™
    const rberuUsers = users.filter(user => 
      user.email?.includes('rberu') || 
      user.email?.includes('rbelu') ||
      user.user_metadata?.store_id === 'rberu' ||
      user.user_metadata?.store_id === 'rbelu'
    );

    if (rberuUsers.length === 0) {
      console.error('âŒ rberuãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    console.log('ğŸ“‹ è¦‹ã¤ã‹ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼:');
    rberuUsers.forEach(user => {
      console.log(`   - Email: ${user.email}`);
      console.log(`     store_id: ${user.user_metadata?.store_id}`);
      console.log(`     created_at: ${user.created_at}`);
    });

    // 2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°
    for (const user of rberuUsers) {
      console.log(`\n2ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.email} ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ä¸­...`);

      const { data, error } = await supabase.auth.admin.updateUserById(
        user.id,
        {
          password: 'hostclub123'
        }
      );

      if (error) {
        console.error(`âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:`, error);
      } else {
        console.log(`âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        console.log(`   Email: ${user.email}`);
        console.log(`   æ–°ã—ã„Password: hostclub123`);
      }
    }

    console.log('\nâœ¨ å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');

  } catch (error) {
    console.error('âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
updateRberuPassword();